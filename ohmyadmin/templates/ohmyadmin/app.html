{% extends 'ohmyadmin/base.html' %}
{% import 'ohmyadmin/actions.html' as actions %}

{% macro menu_heading(label) %}
    <div class="text-xs uppercase text-gray-500 font-medium px-3 pt-2">{{ label }}</div>
{% endmacro %}

{% macro menu_item(item, active) %}
    {% set base_classes = 'hover:bg-gray-200' %}
    {% set active_classes = 'text-accent-900 bg-accent-100 hover:bg-accent-200' %}
    {% set state_classes = active_classes if active else base_classes %}
    <a class="w-full rounded px-3 py-2 text-sm font-medium flex items-center gap-2 {{ state_classes }}"
       href="{{ item.url }}">
        {% if item.icon %}<span class="text-gray-400">{{ item.icon }}</span>{% endif %}
        {{ item.label }}
    </a>
{% endmacro %}

{% block main %}
    <div class="flex flex-col md:flex-row w-full h-full overflow-hidden">
        <aside
            class="w-full md:w-72 bg-gray-100 border-r border-r-gray-200 flex-shrink-0 overflow-y-auto max-h-screen px-4 py-6 flex flex-col gap-5">
            <section class="px-3">
                <a href="{{ url_for('ohmyadmin.welcome') }}">
                    <img src="{{ theme.logo }}" class="h-8">
                </a>
            </section>
            <section class="space-y-2">
                {% for menu_group in ohmyadmin_main_menu %}
                    <div class="space-y-px">
                        {% if menu_group.label %}
                            {{ menu_heading(menu_group.label) }}
                        {% endif %}
                        {% for item in menu_group.children %}
                            {{ menu_item(item, url_matches(item.url)) }}
                        {% endfor %}
                    </div>
                {% endfor %}
            </section>
            <section class="mt-auto">
                <button id="user-menu" type="button"
                        class="flex gap-2 items-center rounded hover:bg-gray-200 active:bg-gray-300 p-2 w-full">
                    <div class="h-10 w-10 rounded overflow-hidden">
                        <img src="{{ request.user.avatar }}" class="w-full h-full">
                    </div>
                    <div class="font-medium">{{ request.user }}</div>
                </button>
                <o-popover trigger="#user-menu" placement="top">
                    <div class="dropdown absolute hidden">
                        {% include 'ohmyadmin/layout/user_menu.html' %}
                    </div>
                </o-popover>
                <form method="post" id="logout-form" action="{{ url_for('ohmyadmin.logout') }}">
                    <input type="hidden" name="next" value="{{ request.url }}">
                </form>
            </section>
        </aside>
        <article class="h-screen flex-grow-0 overflow-y-auto w-full p-10">
            <header class="mb-10">
                <div>{% include 'ohmyadmin/breadcrumbs/breadcrumbs.html' %}</div>
                <div class="flex justify-between gap-5">
                    <div class="flex-shrink-0">
                        <h1 class="text-2xl font-semibold mb-1">
                            {% block page_title %}{% if page_title is defined %}{{ page_title }}{% endif %}{% endblock %}
                        </h1>
                        {% if page_description is defined %}
                            <div>{{ page_description }}</div>
                        {% endif %}
                    </div>
                    <div class="flex items-center gap-2 justify-end flex-wrap">
                        {% block page_actions %}
                            {% call actions.action_toolbar() %}
                                {% if model is undefined %}
                                {% set model = none %}
                                {% endif %}
                                {% for action in screen.get_page_actions() %}
                                    {{ actions.action_button(request, action, screen, model) }}
                                {% endfor %}
                            {% endcall %}
                        {% endblock %}
                    </div>
                </div>
            </header>
            <main>
                <!-- metrics -->
                {% if screen.get_page_metrics() %}
                    <section class="grid grid-cols-12 gap-5 mb-10">
                        {% for metric in screen.get_page_metrics() %}
                            {% set update_interval = metric.update_interval %}
                            <div class="col-span-{{ metric.size }} h-40"
                                 hx-trigger="load{{ ', every:{interval}s'.format(interval=update_interval) if update_interval else '' }}"
                                 hx-target="this"
                                 hx-get="{{ url_for(metric.get_url_name(screen.url_name)) }}">
                            </div>
                        {% endfor %}
                    </section>
                {% endif %}

                {% block content %}{% endblock %}
            </main>
        </article>
    </div>
{% endblock %}
